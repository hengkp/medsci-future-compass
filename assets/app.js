// web/assets/app.js
const { LIFF_ID, GAS_WEBAPP_URL, OA_URL } = window.APP_CONFIG;

let lineUserId = "";     // will stay "" in guest mode
let lineDisplayName = ""; // optional
let currentQ = 0;
let scores = { SCIENTIST: 0, DATA: 0, HEALER: 0, CREATIVE: 0 };
let userAnswers = [];

const questions = [
  { q: "1. ‡∏ñ‡πâ‡∏≤‡πÇ‡∏•‡∏Å‡∏ñ‡∏π‡∏Å‡πÑ‡∏ß‡∏£‡∏±‡∏™‡∏õ‡∏£‡∏¥‡∏®‡∏ô‡∏≤‡πÇ‡∏à‡∏°‡∏ï‡∏µ ‡∏ô‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏£‡∏±‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÑ‡∏´‡∏ô?", answers: [
    { text: "‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏´‡∏≤‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πá‡∏ö", type: "SCIENTIST" },
    { text: "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏î", type: "DATA" },
    { text: "‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢", type: "HEALER" },
    { text: "‡∏ó‡∏≥‡∏™‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå", type: "CREATIVE" },
  ]},
  { q: "2. ‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á ‡∏ô‡πâ‡∏≠‡∏á‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏ä‡∏≠‡∏ö‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£?", answers: [
    { text: "‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô / ‡πÅ‡∏Å‡πâ‡∏õ‡∏£‡∏¥‡∏®‡∏ô‡∏≤", type: "DATA" },
    { text: "‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô / ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ", type: "CREATIVE" },
    { text: "‡∏î‡∏π‡∏™‡∏≤‡∏£‡∏Ñ‡∏î‡∏µ / ‡∏ó‡∏î‡∏•‡∏≠‡∏á", type: "SCIENTIST" },
    { text: "‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô / ‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤", type: "HEALER" },
  ]},
  { q: "3. ‡πÉ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏ß‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏ô‡πâ‡∏≠‡∏á‡∏ä‡∏≠‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÑ‡∏´‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î?", answers: [
    { text: "‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå", type: "HEALER" },
    { text: "‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á", type: "SCIENTIST" },
    { text: "‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ã‡∏•‡∏•‡πå (‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ)", type: "CREATIVE" },
    { text: "‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£", type: "DATA" },
  ]},
  { q: "4. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏≠‡∏î‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå ‡∏≠‡∏¢‡∏≤‡∏Å‡∏°‡∏µ‡∏û‡∏•‡∏±‡∏á‡∏≠‡∏∞‡πÑ‡∏£?", answers: [
    { text: "‡πÄ‡∏ô‡∏ï‡∏£‡∏ó‡∏¥‡∏û‡∏¢‡πå ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÇ‡∏£‡∏Ñ", type: "SCIENTIST" },
    { text: "‡∏û‡∏•‡∏±‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤ ‡πÄ‡∏¢‡∏µ‡∏¢‡∏ß‡∏¢‡∏≤‡∏ö‡∏≤‡∏î‡πÅ‡∏ú‡∏•", type: "HEALER" },
    { text: "‡∏™‡∏°‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå", type: "DATA" },
    { text: "‡πÄ‡∏™‡∏Å‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á", type: "CREATIVE" },
  ]},
  { q: "5. ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ñ‡∏∑‡∏≠?", answers: [
    { text: "‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡∏™‡∏¥‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏•‡∏Å", type: "SCIENTIST" },
    { text: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ô‡∏à‡∏î‡∏à‡∏≥", type: "CREATIVE" },
    { text: "‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç", type: "HEALER" },
    { text: "‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ", type: "DATA" },
  ]},
];

const archetypes = {
  HEALER: {
    thTitle: "‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏µ‡∏¢‡∏ß‡∏¢‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°",
    enName: "The Social Healer",
    icon: "‚ù§Ô∏è",
    desc: "‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ! ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏à‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô ‡πÅ‡∏•‡∏∞‡∏ä‡∏≠‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏Ñ‡∏ô‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á",
    tip: "‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏°‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°",
    jobs: ["‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå", "‡∏ô‡∏±‡∏Å‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç", "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£"],
    wow: false,
  },
  DATA: {
    thTitle: "‡∏û‡πà‡∏≠‡∏°‡∏î‡πÅ‡∏´‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
    enName: "The Data Wizard",
    icon: "üíª",
    desc: "‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏°‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô! ‡∏ä‡∏≠‡∏ö‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô",
    tip: "‡∏•‡∏≠‡∏á‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á AI ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏¥‡∏î‡∏õ‡∏µ‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ù‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì",
    jobs: ["‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (Health Data)", "‡∏ô‡∏±‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå", "‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û"],
    wow: true,
  },
  CREATIVE: {
    thTitle: "‡∏ô‡∏±‡∏Å‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå",
    enName: "The Creative Innovator",
    icon: "üé®",
    desc: "‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î! ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏≤‡∏Å‡πÜ ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°",
    tip: "‡∏•‡∏≠‡∏á‡∏ô‡∏≥‡∏®‡∏¥‡∏•‡∏õ‡∏∞‡∏°‡∏≤‡∏ú‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡∏π‡∏™‡∏¥ ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏≥‡∏™‡∏∏‡∏î‡πÜ ‡πÑ‡∏î‡πâ",
    jobs: ["‡∏ô‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û", "Medical Illustrator", "‡∏ô‡∏±‡∏Å‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û"],
    wow: false,
  },
  SCIENTIST: {
    thTitle: "‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå",
    enName: "The Guardian Scientist",
    icon: "üî¨",
    desc: "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏¢‡∏≠‡∏î‡∏ô‡∏±‡∏Å‡∏™‡∏∑‡∏ö‡πÅ‡∏´‡πà‡∏á‡πÇ‡∏•‡∏Å‡∏à‡∏∏‡∏•‡∏ó‡∏£‡∏£‡∏®‡∏ô‡πå! ‡∏ä‡πà‡∏≤‡∏á‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï ‡∏ä‡∏≠‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ‡∏ï‡πà‡∏≠‡∏õ‡∏£‡∏¥‡∏®‡∏ô‡∏≤",
    tip: "‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° '‡∏ó‡∏≥‡πÑ‡∏°' ‡∏ö‡πà‡∏≠‡∏¢‡πÜ ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏™‡∏π‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì",
    jobs: ["‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå", "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£", "‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏à‡∏±‡∏¢/‡∏ô‡∏±‡∏Å‡∏ô‡∏¥‡∏ï‡∏¥‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå"],
    wow: true,
  },
};

function $(id) { return document.getElementById(id); }

function setStatus(ok, html) {
  const statusDiv = $("liff-status");
  statusDiv.className = ok
    ? "text-sm text-green-700 font-bold bg-green-50 py-2 px-4 rounded-xl flex items-center justify-center gap-2 border border-green-200 shadow-sm"
    : "text-sm text-gray-500 font-medium bg-gray-50 py-2 px-4 rounded-xl flex items-center justify-center gap-2 border border-gray-200";
  statusDiv.innerHTML = html;
}

/**
 * ‚úÖ KEY CHANGE:
 * - init LIFF if possible
 * - DO NOT call liff.login() at all
 * - If logged in, use profile; else guest mode
 */
window.addEventListener("load", async () => {
  const startBtn = $("btn-start");

  const fallbackTimer = setTimeout(() => {
    if (startBtn.disabled) {
      setStatus(false, "üë§ ‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)");
      startBtn.disabled = false;
    }
  }, 8000);

  // If LIFF SDK not loaded -> guest mode
  if (typeof liff === "undefined") {
    clearTimeout(fallbackTimer);
    setStatus(false, "üë§ ‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)");
    startBtn.disabled = false;
    return;
  }

  try {
    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: false });
    await liff.ready;
    clearTimeout(fallbackTimer);

    // If user is already logged in -> get profile (no forcing)
    if (liff.isLoggedIn && liff.isLoggedIn()) {
      const profile = await liff.getProfile();
      lineUserId = profile?.userId || "";
      lineDisplayName = profile?.displayName || "";

      setStatus(true, `‚úÖ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì ${lineDisplayName || "‡∏Ñ‡∏£‡∏±‡∏ö"} ‚ú®`);

      // email only if scope email enabled AND user is logged in
      const token = liff.getDecodedIDToken?.();
      const email = token?.email;
      if (email && $("inp-email") && !$("inp-email").value) $("inp-email").value = email;
    } else {
      // Not logged in -> guest mode
      setStatus(false, "üë§ ‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)");
    }

    startBtn.disabled = false;
    startBtn.classList.add("pulse-slow");
  } catch (err) {
    // Any LIFF error -> guest mode
    clearTimeout(fallbackTimer);
    setStatus(false, "üë§ ‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)");
    startBtn.disabled = false;
  }
});

// --- UI flow ---
function switchView(fromId, toId) {
  $(fromId).classList.add("hidden");
  $(toId).classList.remove("hidden");
  $("main-scroll").scrollTop = 0;
}

window.startQuiz = function startQuiz() {
  switchView("view-landing", "view-quiz");
  renderQuestion();
};

function renderQuestion() {
  const qData = questions[currentQ];
  $("q-num").innerText = currentQ + 1;
  $("progress-bar").style.width = `${((currentQ + 1) / questions.length) * 100}%`;
  $("q-text").innerText = qData.q;

  const container = $("q-answers");
  container.innerHTML = "";

  qData.answers.forEach(ans => {
    const btn = document.createElement("button");
    btn.className = "choice-btn";
    btn.innerHTML = `<span>${ans.text}</span> <span class="text-gray-300 text-xl">‚ûú</span>`;
    btn.onclick = () => {
      scores[ans.type]++;
      userAnswers.push(ans.text);
      currentQ++;
      if (currentQ < questions.length) renderQuestion();
      else showResult();
    };
    container.appendChild(btn);
  });
}

function computeResultType() {
  return Object.keys(scores).reduce((a, b) => (scores[a] > scores[b] ? a : b));
}

function setResultUI(type) {
  const r = archetypes[type];

  $("res-icon").innerText = r.icon;
  $("res-title").innerText = r.thTitle;
  $("res-en").innerText = r.enName;
  $("res-desc").innerText = r.desc;
  $("res-tip").innerText = r.tip;

  const jobsUl = $("res-jobs");
  jobsUl.innerHTML = "";
  r.jobs.forEach(j => {
    const li = document.createElement("li");
    li.textContent = j;
    jobsUl.appendChild(li);
  });

  const wow = $("res-wow");
  if (r.wow) wow.classList.remove("hidden");
  else wow.classList.add("hidden");
}

function showResult() {
  const type = computeResultType();
  setResultUI(type);
  switchView("view-quiz", "view-result");
}

window.submitForm = async function submitForm() {
  const btn = $("btn-submit");
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="loader"></span>';

  const type = computeResultType();
  const r = archetypes[type];

  const payload = {
    action: "submit",
    data: {
      name: $("inp-name").value.trim(),
      grade: $("inp-grade").value,
      province: $("inp-province").value.trim(),
      school: $("inp-school").value.trim(),
      phone: $("inp-phone").value.trim(),
      email: $("inp-email").value.trim(),

      resultType: type,
      resultTH: r.thTitle,
      resultEN: r.enName,

      // ‚úÖ will be "" in guest mode
      lineUserId,

      q1: userAnswers[0] || "",
      q2: userAnswers[1] || "",
      q3: userAnswers[2] || "",
      q4: userAnswers[3] || "",
      q5: userAnswers[4] || ""
    }
  };

  try {
    const res = await fetch(GAS_WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload),
    });

    let out = null;
    try { out = await res.json(); } catch (_) {}

    if (out && out.status === "error") throw new Error(out.message || "Unknown backend error");

    switchView("view-result", "view-success");
  } catch (e) {
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (e?.message || e));
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
};

window.closeApp = function closeApp() {
  if (typeof liff !== "undefined" && liff.isInClient && liff.isInClient()) liff.closeWindow();
  else window.location.href = OA_URL;
};